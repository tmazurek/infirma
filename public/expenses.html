<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expenses - Infirma</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .expense-list {
      margin-top: 20px;
    }
    .expense-actions {
      display: flex;
      gap: 10px;
    }
    .btn-edit, .btn-delete {
      padding: 5px 10px;
      font-size: 14px;
    }
    .btn-edit {
      background-color: #28a745;
    }
    .btn-delete {
      background-color: #dc3545;
    }
    .filters {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .filters-row {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }
    .filter-group {
      flex: 1;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 600px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Infirma</h1>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/company-profile">Company Profile</a></li>
          <li><a href="/clients">Clients</a></li>
          <li><a href="/invoices">Invoices</a></li>
          <li><a href="/expenses">Expenses</a></li>
          <li><a href="/summary">Summary</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="mt-3">
      <h2>Expenses</h2>
      <p>Track and manage your business expenses.</p>

      <div id="message-container" class="mb-3" style="display: none;"></div>

      <div class="filters">
        <h3>Filters</h3>
        <form id="filter-form">
          <div class="filters-row">
            <div class="filter-group">
              <label for="start-date">Start Date</label>
              <input type="date" id="start-date" name="startDate">
            </div>
            <div class="filter-group">
              <label for="end-date">End Date</label>
              <input type="date" id="end-date" name="endDate">
            </div>
            <div class="filter-group">
              <label for="category">Category</label>
              <select id="category" name="category">
                <option value="">All Categories</option>
                <!-- Categories will be added here dynamically -->
              </select>
            </div>
          </div>
          <button type="submit" class="btn">Apply Filters</button>
          <button type="button" id="clear-filters-btn" class="btn" style="background-color: #6c757d;">Clear Filters</button>
        </form>
      </div>

      <button id="add-expense-btn" class="btn mb-3">Add New Expense</button>

      <div class="expense-list">
        <table id="expenses-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Vendor</th>
              <th>Description</th>
              <th>Category</th>
              <th>Net Amount</th>
              <th>VAT</th>
              <th>Gross Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="expenses-table-body">
            <!-- Expense rows will be added here dynamically -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Expense Modal Form -->
  <div id="expense-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modal-title">Add New Expense</h3>

      <form id="expense-form">
        <input type="hidden" id="expense-id">

        <div class="form-group">
          <label for="expense_date">Date *</label>
          <input type="date" id="expense_date" name="expense_date" required>
        </div>

        <div class="form-group">
          <label for="vendor_name">Vendor</label>
          <input type="text" id="vendor_name" name="vendor_name">
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <input type="text" id="description" name="description" required>
        </div>

        <div class="form-group">
          <label for="category_input">Category</label>
          <input type="text" id="category_input" name="category" list="categories-list">
          <datalist id="categories-list">
            <!-- Categories will be added here dynamically -->
          </datalist>
        </div>

        <div class="form-group">
          <label for="amount_net">Net Amount</label>
          <input type="number" id="amount_net" name="amount_net" min="0" step="0.01">
        </div>

        <div class="form-group">
          <label for="vat_amount_paid">VAT Amount</label>
          <input type="number" id="vat_amount_paid" name="vat_amount_paid" min="0" step="0.01">
        </div>

        <div class="form-group">
          <label for="amount_gross">Gross Amount *</label>
          <input type="number" id="amount_gross" name="amount_gross" min="0.01" step="0.01" required>
        </div>

        <button type="submit" class="btn">Save Expense</button>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete this expense?</p>
      <div class="expense-actions">
        <button id="confirm-delete" class="btn btn-delete">Delete</button>
        <button id="cancel-delete" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <footer class="text-center mt-3">
    <div class="container">
      <p>&copy; 2025 Infirma - Accounting App</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const expensesTableBody = document.getElementById('expenses-table-body');
      const addExpenseBtn = document.getElementById('add-expense-btn');
      const expenseModal = document.getElementById('expense-modal');
      const deleteModal = document.getElementById('delete-modal');
      const expenseForm = document.getElementById('expense-form');
      const filterForm = document.getElementById('filter-form');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');
      const modalTitle = document.getElementById('modal-title');
      const expenseIdInput = document.getElementById('expense-id');
      const messageContainer = document.getElementById('message-container');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      const categorySelect = document.getElementById('category');
      const categoriesList = document.getElementById('categories-list');

      // Close buttons for modals
      const closeButtons = document.querySelectorAll('.close');
      closeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          expenseModal.style.display = 'none';
          deleteModal.style.display = 'none';
        });
      });

      // Cancel delete button
      cancelDeleteBtn.addEventListener('click', function() {
        deleteModal.style.display = 'none';
      });

      // Set default expense date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('expense_date').value = today;

      // Load expenses and categories on page load
      loadExpenses();
      loadCategories();

      // Add expense button click
      addExpenseBtn.addEventListener('click', function() {
        resetExpenseForm();
        modalTitle.textContent = 'Add New Expense';
        expenseModal.style.display = 'block';
      });

      // Expense form submission
      expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveExpense();
      });

      // Filter form submission
      filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadExpenses();
      });

      // Clear filters button click
      clearFiltersBtn.addEventListener('click', function() {
        filterForm.reset();
        loadExpenses();
      });

      // Function to load all expenses
      function loadExpenses() {
        // Get filter values
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const category = document.getElementById('category').value;

        // Build query string
        let queryString = '';
        if (startDate) queryString += `startDate=${startDate}&`;
        if (endDate) queryString += `endDate=${endDate}&`;
        if (category) queryString += `category=${encodeURIComponent(category)}&`;

        // Remove trailing & if present
        if (queryString.endsWith('&')) {
          queryString = queryString.slice(0, -1);
        }

        // Add ? if query string is not empty
        if (queryString) {
          queryString = '?' + queryString;
        }

        fetch(`/api/expenses${queryString}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch expenses');
            }
            return response.json();
          })
          .then(expenses => {
            displayExpenses(expenses);
          })
          .catch(error => {
            showMessage('error', 'Error loading expenses: ' + error.message);
          });
      }

      // Function to load categories
      function loadCategories() {
        fetch('/api/expenses/categories')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch categories');
            }
            return response.json();
          })
          .then(categories => {
            // Populate category select in filter form
            categorySelect.innerHTML = '<option value="">All Categories</option>';

            // Populate datalist for category input in expense form
            categoriesList.innerHTML = '';

            categories.forEach(category => {
              // Add to filter select
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              categorySelect.appendChild(option);

              // Add to datalist
              const dataOption = document.createElement('option');
              dataOption.value = category;
              categoriesList.appendChild(dataOption);
            });
          })
          .catch(error => {
            console.error('Error loading categories:', error);
          });
      }

      // Function to display expenses in the table
      function displayExpenses(expenses) {
        expensesTableBody.innerHTML = '';

        if (expenses.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="8" class="text-center">No expenses found. Add your first expense!</td>';
          expensesTableBody.appendChild(row);
          return;
        }

        expenses.forEach(expense => {
          const row = document.createElement('tr');

          // Format date
          const expenseDate = new Date(expense.expense_date).toLocaleDateString();

          row.innerHTML = `
            <td>${expenseDate}</td>
            <td>${expense.vendor_name || '-'}</td>
            <td>${expense.description}</td>
            <td>${expense.category || '-'}</td>
            <td>${expense.amount_net ? expense.amount_net.toFixed(2) + ' PLN' : '-'}</td>
            <td>${expense.vat_amount_paid ? expense.vat_amount_paid.toFixed(2) + ' PLN' : '-'}</td>
            <td>${expense.amount_gross.toFixed(2)} PLN</td>
            <td class="expense-actions">
              <button class="btn btn-edit" data-id="${expense.id}">Edit</button>
              <button class="btn btn-delete" data-id="${expense.id}">Delete</button>
            </td>
          `;
          expensesTableBody.appendChild(row);
        });

        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-id');
            editExpense(expenseId);
          });
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-id');
            showDeleteConfirmation(expenseId);
          });
        });
      }

      // Function to edit an expense
      function editExpense(expenseId) {
        fetch(`/api/expenses/${expenseId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch expense details');
            }
            return response.json();
          })
          .then(expense => {
            // Populate form with expense data
            expenseIdInput.value = expense.id;
            document.getElementById('expense_date').value = expense.expense_date;
            document.getElementById('vendor_name').value = expense.vendor_name || '';
            document.getElementById('description').value = expense.description;
            document.getElementById('category_input').value = expense.category || '';
            document.getElementById('amount_net').value = expense.amount_net || '';
            document.getElementById('vat_amount_paid').value = expense.vat_amount_paid || '';
            document.getElementById('amount_gross').value = expense.amount_gross;

            // Update modal title and show modal
            modalTitle.textContent = 'Edit Expense';
            expenseModal.style.display = 'block';
          })
          .catch(error => {
            showMessage('error', 'Error loading expense details: ' + error.message);
          });
      }

      // Function to show delete confirmation
      function showDeleteConfirmation(expenseId) {
        confirmDeleteBtn.setAttribute('data-id', expenseId);
        deleteModal.style.display = 'block';

        // Set up the confirm delete button
        confirmDeleteBtn.onclick = function() {
          const id = this.getAttribute('data-id');
          deleteExpense(id);
        };
      }

      // Function to delete an expense
      function deleteExpense(expenseId) {
        fetch(`/api/expenses/${expenseId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || 'Failed to delete expense');
            });
          }
          return response.json();
        })
        .then(data => {
          deleteModal.style.display = 'none';
          showMessage('success', data.message);
          loadExpenses(); // Reload the expenses list
        })
        .catch(error => {
          deleteModal.style.display = 'none';
          showMessage('error', error.message);
        });
      }

      // Function to save an expense (create or update)
      function saveExpense() {
        const expenseId = expenseIdInput.value;
        const isUpdate = expenseId !== '';

        const expenseData = {
          expense_date: document.getElementById('expense_date').value,
          vendor_name: document.getElementById('vendor_name').value,
          description: document.getElementById('description').value,
          category: document.getElementById('category_input').value,
          amount_net: document.getElementById('amount_net').value || null,
          vat_amount_paid: document.getElementById('vat_amount_paid').value || null,
          amount_gross: document.getElementById('amount_gross').value
        };

        const url = isUpdate ? `/api/expenses/${expenseId}` : '/api/expenses';
        const method = isUpdate ? 'PUT' : 'POST';

        fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(expenseData)
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || 'Failed to save expense');
            });
          }
          return response.json();
        })
        .then(data => {
          expenseModal.style.display = 'none';
          showMessage('success', data.message);
          loadExpenses(); // Reload the expenses list
          loadCategories(); // Reload categories in case a new one was added
        })
        .catch(error => {
          showMessage('error', error.message);
        });
      }

      // Function to reset the expense form
      function resetExpenseForm() {
        expenseForm.reset();
        expenseIdInput.value = '';
        document.getElementById('expense_date').value = today;
      }

      // Function to show messages
      function showMessage(type, message) {
        messageContainer.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${message}</div>`;
        messageContainer.style.display = 'block';

        // Add some basic styling for messages
        const style = document.createElement('style');
        style.textContent = `
          .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
          .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
        `;
        document.head.appendChild(style);

        // Auto-hide message after 5 seconds
        setTimeout(() => {
          messageContainer.style.display = 'none';
        }, 5000);
      }

      // Close modal when clicking outside of it
      window.addEventListener('click', function(event) {
        if (event.target === expenseModal) {
          expenseModal.style.display = 'none';
        }
        if (event.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
