<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Profile - Infirma</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>Infirma</h1>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/company-profile">Company Profile</a></li>
          <li><a href="/clients">Clients</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="mt-3">
      <h2>Company Profile</h2>
      <p>Manage your company details for invoices and tax calculations.</p>

      <div id="message-container" class="mb-3" style="display: none;"></div>

      <form id="company-profile-form" class="mb-3">
        <div class="form-group">
          <label for="company_name">Company Name *</label>
          <input type="text" id="company_name" name="company_name" required>
        </div>

        <div class="form-group">
          <label for="nip">NIP (Tax ID) *</label>
          <input type="text" id="nip" name="nip" required pattern="[0-9]{10}" title="NIP must be 10 digits">
        </div>

        <div class="form-group">
          <label for="street_address">Street Address</label>
          <input type="text" id="street_address" name="street_address">
        </div>

        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" name="city">
        </div>

        <div class="form-group">
          <label for="postal_code">Postal Code</label>
          <input type="text" id="postal_code" name="postal_code" pattern="[0-9]{2}-[0-9]{3}" title="Format: 00-000">
        </div>

        <div class="form-group">
          <label for="bank_account_number">Bank Account Number</label>
          <input type="text" id="bank_account_number" name="bank_account_number">
        </div>

        <div class="form-group">
          <label for="default_vat_rate">Default VAT Rate (%)</label>
          <input type="number" id="default_vat_rate" name="default_vat_rate" min="0" max="100" step="1" value="23">
        </div>

        <button type="submit" class="btn">Save Company Profile</button>
      </form>
    </section>
  </main>

  <footer class="text-center mt-3">
    <div class="container">
      <p>&copy; 2025 Infirma - Accounting App</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('company-profile-form');
      const messageContainer = document.getElementById('message-container');

      // Fetch existing company profile data
      fetchCompanyProfile();

      // Handle form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        saveCompanyProfile();
      });

      // Function to fetch company profile
      function fetchCompanyProfile() {
        fetch('/api/company-profile')
          .then(response => {
            if (response.status === 404) {
              // No profile found, that's okay for a new user
              return null;
            }
            if (!response.ok) {
              throw new Error('Failed to fetch company profile');
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              // Populate form with existing data
              document.getElementById('company_name').value = data.company_name || '';
              document.getElementById('nip').value = data.nip || '';
              document.getElementById('street_address').value = data.street_address || '';
              document.getElementById('city').value = data.city || '';
              document.getElementById('postal_code').value = data.postal_code || '';
              document.getElementById('bank_account_number').value = data.bank_account_number || '';
              document.getElementById('default_vat_rate').value = data.default_vat_rate || 23;
            }
          })
          .catch(error => {
            showMessage('error', 'Error loading company profile: ' + error.message);
          });
      }

      // Function to save company profile
      function saveCompanyProfile() {
        const formData = {
          company_name: document.getElementById('company_name').value,
          nip: document.getElementById('nip').value,
          street_address: document.getElementById('street_address').value,
          city: document.getElementById('city').value,
          postal_code: document.getElementById('postal_code').value,
          bank_account_number: document.getElementById('bank_account_number').value,
          default_vat_rate: document.getElementById('default_vat_rate').value
        };

        fetch('/api/company-profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || 'Failed to save company profile');
            });
          }
          return response.json();
        })
        .then(data => {
          showMessage('success', data.message);
        })
        .catch(error => {
          showMessage('error', error.message);
        });
      }

      // Function to show messages
      function showMessage(type, message) {
        messageContainer.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${message}</div>`;
        messageContainer.style.display = 'block';

        // Add some basic styling for messages
        const style = document.createElement('style');
        style.textContent = `
          .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
          .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
        `;
        document.head.appendChild(style);

        // Auto-hide message after 5 seconds
        setTimeout(() => {
          messageContainer.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>
</html>
