<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Invoice - Infirma</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .invoice-items {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .item-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: flex-end;
    }
    .item-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    .btn-remove-item {
      background-color: #dc3545;
      margin-bottom: 8px;
    }
    .totals {
      margin-top: 20px;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
    }
    .totals-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .totals-row.grand-total {
      font-weight: bold;
      font-size: 1.2em;
      border-top: 1px solid #ddd;
      padding-top: 5px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Infirma</h1>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/company-profile">Company Profile</a></li>
          <li><a href="/clients">Clients</a></li>
          <li><a href="/invoices">Invoices</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="mt-3">
      <h2>Create New Invoice</h2>
      <p>Fill in the details to create a new invoice.</p>
      
      <div id="message-container" class="mb-3" style="display: none;"></div>
      
      <form id="invoice-form" class="mb-3">
        <div class="form-group">
          <label for="client_id">Client *</label>
          <select id="client_id" name="client_id" required>
            <option value="">Select a client</option>
            <!-- Client options will be added here dynamically -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="issue_date">Issue Date *</label>
          <input type="date" id="issue_date" name="issue_date" required>
        </div>
        
        <div class="form-group">
          <label for="due_date">Due Date</label>
          <input type="date" id="due_date" name="due_date">
        </div>
        
        <div class="form-group">
          <label for="payment_terms">Payment Terms</label>
          <input type="text" id="payment_terms" name="payment_terms" placeholder="e.g., 14 days">
        </div>
        
        <h3>Invoice Items</h3>
        <div id="invoice-items" class="invoice-items">
          <!-- Item rows will be added here dynamically -->
        </div>
        
        <button type="button" id="add-item-btn" class="btn">Add Item</button>
        
        <div class="totals">
          <div class="totals-row">
            <span>Total Net:</span>
            <span id="total-net">0.00 PLN</span>
          </div>
          <div class="totals-row">
            <span>Total VAT:</span>
            <span id="total-vat">0.00 PLN</span>
          </div>
          <div class="totals-row grand-total">
            <span>Total Gross:</span>
            <span id="total-gross">0.00 PLN</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="Draft">Draft</option>
            <option value="Issued">Issued</option>
          </select>
        </div>
        
        <button type="submit" class="btn">Create Invoice</button>
        <a href="/invoices" class="btn" style="background-color: #6c757d;">Cancel</a>
      </form>
    </section>
  </main>

  <footer class="text-center mt-3">
    <div class="container">
      <p>&copy; 2025 Infirma - Accounting App</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const invoiceForm = document.getElementById('invoice-form');
      const clientSelect = document.getElementById('client_id');
      const invoiceItemsContainer = document.getElementById('invoice-items');
      const addItemBtn = document.getElementById('add-item-btn');
      const totalNetElement = document.getElementById('total-net');
      const totalVatElement = document.getElementById('total-vat');
      const totalGrossElement = document.getElementById('total-gross');
      const messageContainer = document.getElementById('message-container');
      
      // Set default issue date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('issue_date').value = today;
      
      // Load clients on page load
      loadClients();
      
      // Add first item row
      addItemRow();
      
      // Add item button click
      addItemBtn.addEventListener('click', function() {
        addItemRow();
      });
      
      // Invoice form submission
      invoiceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        createInvoice();
      });
      
      // Function to load all clients
      function loadClients() {
        fetch('/api/clients')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch clients');
            }
            return response.json();
          })
          .then(clients => {
            populateClientSelect(clients);
          })
          .catch(error => {
            showMessage('error', 'Error loading clients: ' + error.message);
          });
      }
      
      // Function to populate client select dropdown
      function populateClientSelect(clients) {
        clientSelect.innerHTML = '<option value="">Select a client</option>';
        
        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = client.client_name;
          clientSelect.appendChild(option);
        });
      }
      
      // Function to add an item row
      function addItemRow() {
        const itemRow = document.createElement('div');
        itemRow.className = 'item-row';
        
        // Generate a unique ID for the item row
        const itemId = Date.now();
        
        itemRow.innerHTML = `
          <div class="form-group">
            <label for="description_${itemId}">Description *</label>
            <input type="text" id="description_${itemId}" name="description" required>
          </div>
          <div class="form-group">
            <label for="quantity_${itemId}">Quantity *</label>
            <input type="number" id="quantity_${itemId}" name="quantity" min="0.01" step="0.01" value="1" required>
          </div>
          <div class="form-group">
            <label for="unit_price_net_${itemId}">Unit Price (Net) *</label>
            <input type="number" id="unit_price_net_${itemId}" name="unit_price_net" min="0.01" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="vat_rate_${itemId}">VAT Rate (%) *</label>
            <input type="number" id="vat_rate_${itemId}" name="vat_rate" min="0" step="1" value="23" required>
          </div>
          <button type="button" class="btn btn-remove-item">Remove</button>
        `;
        
        invoiceItemsContainer.appendChild(itemRow);
        
        // Add event listener to remove button
        itemRow.querySelector('.btn-remove-item').addEventListener('click', function() {
          if (document.querySelectorAll('.item-row').length > 1) {
            itemRow.remove();
            calculateTotals();
          } else {
            showMessage('error', 'At least one item is required');
          }
        });
        
        // Add event listeners to calculate totals when values change
        const inputs = itemRow.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          input.addEventListener('input', calculateTotals);
        });
      }
      
      // Function to calculate totals
      function calculateTotals() {
        let totalNet = 0;
        let totalVat = 0;
        let totalGross = 0;
        
        const itemRows = document.querySelectorAll('.item-row');
        
        itemRows.forEach(row => {
          const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
          const unitPriceNet = parseFloat(row.querySelector('input[name="unit_price_net"]').value) || 0;
          const vatRate = parseFloat(row.querySelector('input[name="vat_rate"]').value) || 0;
          
          const itemTotalNet = quantity * unitPriceNet;
          const itemTotalVat = itemTotalNet * (vatRate / 100);
          const itemTotalGross = itemTotalNet + itemTotalVat;
          
          totalNet += itemTotalNet;
          totalVat += itemTotalVat;
          totalGross += itemTotalGross;
        });
        
        // Update totals display
        totalNetElement.textContent = totalNet.toFixed(2) + ' PLN';
        totalVatElement.textContent = totalVat.toFixed(2) + ' PLN';
        totalGrossElement.textContent = totalGross.toFixed(2) + ' PLN';
      }
      
      // Function to create an invoice
      function createInvoice() {
        // Collect form data
        const clientId = document.getElementById('client_id').value;
        const issueDate = document.getElementById('issue_date').value;
        const dueDate = document.getElementById('due_date').value;
        const paymentTerms = document.getElementById('payment_terms').value;
        const status = document.getElementById('status').value;
        
        // Collect items data
        const items = [];
        const itemRows = document.querySelectorAll('.item-row');
        
        itemRows.forEach(row => {
          const description = row.querySelector('input[name="description"]').value;
          const quantity = parseFloat(row.querySelector('input[name="quantity"]').value);
          const unitPriceNet = parseFloat(row.querySelector('input[name="unit_price_net"]').value);
          const vatRate = parseFloat(row.querySelector('input[name="vat_rate"]').value);
          
          items.push({
            description,
            quantity,
            unit_price_net: unitPriceNet,
            vat_rate: vatRate
          });
        });
        
        // Create invoice data object
        const invoiceData = {
          client_id: clientId,
          issue_date: issueDate,
          due_date: dueDate || null,
          payment_terms: paymentTerms || null,
          status: status,
          items: items
        };
        
        // Send request to create invoice
        fetch('/api/invoices', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(invoiceData)
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || 'Failed to create invoice');
            });
          }
          return response.json();
        })
        .then(data => {
          showMessage('success', data.message);
          
          // Redirect to invoices list after a short delay
          setTimeout(() => {
            window.location.href = '/invoices';
          }, 1500);
        })
        .catch(error => {
          showMessage('error', error.message);
        });
      }
      
      // Function to show messages
      function showMessage(type, message) {
        messageContainer.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${message}</div>`;
        messageContainer.style.display = 'block';
        
        // Add some basic styling for messages
        const style = document.createElement('style');
        style.textContent = `
          .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
          .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
        `;
        document.head.appendChild(style);
        
        // Auto-hide message after 5 seconds
        setTimeout(() => {
          messageContainer.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>
</html>
