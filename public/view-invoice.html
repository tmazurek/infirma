<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Invoice - Infirma</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .invoice-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    .invoice-title {
      font-size: 24px;
      color: #343a40;
      margin-bottom: 5px;
    }
    .invoice-number {
      font-size: 18px;
      color: #6c757d;
    }
    .invoice-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      margin-top: 10px;
    }
    .status-draft {
      background-color: #ffc107;
      color: #212529;
    }
    .status-issued {
      background-color: #17a2b8;
      color: white;
    }
    .status-paid {
      background-color: #28a745;
      color: white;
    }
    .company-client {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    .company-info, .client-info {
      width: 48%;
    }
    .info-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #343a40;
    }
    .dates {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    .date-box {
      width: 30%;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
    .date-label {
      font-weight: bold;
      color: #343a40;
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    .items-table th, .items-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .items-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .items-table tr:last-child td {
      border-bottom: none;
    }
    .text-right {
      text-align: right;
    }
    .totals {
      margin-left: auto;
      width: 300px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
    }
    .total-row:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.1em;
      padding-top: 12px;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Infirma</h1>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/company-profile">Company Profile</a></li>
          <li><a href="/clients">Clients</a></li>
          <li><a href="/invoices">Invoices</a></li>
          <li><a href="/expenses">Expenses</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="mt-3">
      <div id="message-container" class="mb-3" style="display: none;"></div>

      <div id="invoice-container" class="invoice-container">
        <!-- Invoice content will be loaded here dynamically -->
        <div class="text-center">Loading invoice...</div>
      </div>

      <div class="actions">
        <a href="/invoices" class="btn">Back to Invoices</a>
        <button id="print-btn" class="btn">Print Invoice</button>
        <button id="download-pdf-btn" class="btn">Download PDF</button>
      </div>
    </section>
  </main>

  <footer class="text-center mt-3">
    <div class="container">
      <p>&copy; 2025 Infirma - Accounting App</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const invoiceContainer = document.getElementById('invoice-container');
      const printBtn = document.getElementById('print-btn');
      const downloadPdfBtn = document.getElementById('download-pdf-btn');
      const messageContainer = document.getElementById('message-container');

      // Get invoice ID from URL
      const urlParts = window.location.pathname.split('/');
      const invoiceId = urlParts[urlParts.length - 1];

      // Load invoice on page load
      loadInvoice(invoiceId);

      // Print button click
      printBtn.addEventListener('click', function() {
        window.print();
      });

      // Download PDF button click
      downloadPdfBtn.addEventListener('click', function() {
        downloadInvoicePdf(invoiceId);
      });

      // Function to load invoice details
      function loadInvoice(id) {
        fetch(`/api/invoices/${id}`)
          .then(response => {
            if (!response.ok) {
              if (response.status === 404) {
                throw new Error('Invoice not found');
              }
              throw new Error('Failed to fetch invoice');
            }
            return response.json();
          })
          .then(invoice => {
            displayInvoice(invoice);
          })
          .catch(error => {
            showMessage('error', 'Error loading invoice: ' + error.message);
            invoiceContainer.innerHTML = `<div class="text-center">Error: ${error.message}</div>`;
          });
      }

      // Function to display invoice details
      function displayInvoice(invoice) {
        // Format dates
        const issueDate = new Date(invoice.issue_date).toLocaleDateString();
        const dueDate = invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : '-';

        // Format status badge
        const statusClass = `status-${invoice.status.toLowerCase()}`;

        // Get company profile from snapshot
        const company = invoice.company_profile_snapshot || {};

        // Build HTML for invoice
        let html = `
          <div class="invoice-header">
            <div>
              <div class="invoice-title">INVOICE</div>
              <div class="invoice-number">${invoice.invoice_number}</div>
              <div class="invoice-status ${statusClass}">${invoice.status}</div>
            </div>
          </div>

          <div class="company-client">
            <div class="company-info">
              <div class="info-title">From:</div>
              <div>${company.company_name || ''}</div>
              <div>NIP: ${company.nip || ''}</div>
              <div>${company.street_address || ''}</div>
              <div>${company.city || ''} ${company.postal_code || ''}</div>
              <div>Bank Account: ${company.bank_account_number || ''}</div>
            </div>

            <div class="client-info">
              <div class="info-title">To:</div>
              <div>${invoice.client_name}</div>
              <div>NIP: ${invoice.client_nip || ''}</div>
              <div>${invoice.client_street_address || ''}</div>
              <div>${invoice.client_city || ''} ${invoice.client_postal_code || ''}</div>
            </div>
          </div>

          <div class="dates">
            <div class="date-box">
              <div class="date-label">Issue Date:</div>
              <div>${issueDate}</div>
            </div>

            <div class="date-box">
              <div class="date-label">Due Date:</div>
              <div>${dueDate}</div>
            </div>

            <div class="date-box">
              <div class="date-label">Payment Terms:</div>
              <div>${invoice.payment_terms || '-'}</div>
            </div>
          </div>

          <table class="items-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Quantity</th>
                <th>Unit Price (Net)</th>
                <th>VAT Rate</th>
                <th>Total (Net)</th>
                <th>VAT</th>
                <th>Total (Gross)</th>
              </tr>
            </thead>
            <tbody>
        `;

        // Add invoice items
        invoice.items.forEach(item => {
          html += `
            <tr>
              <td>${item.description}</td>
              <td>${item.quantity}</td>
              <td>${item.unit_price_net.toFixed(2)} PLN</td>
              <td>${item.vat_rate}%</td>
              <td>${item.item_total_net.toFixed(2)} PLN</td>
              <td>${item.item_total_vat.toFixed(2)} PLN</td>
              <td>${item.item_total_gross.toFixed(2)} PLN</td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>

          <div class="totals">
            <div class="total-row">
              <span>Total Net:</span>
              <span>${invoice.total_net.toFixed(2)} PLN</span>
            </div>
            <div class="total-row">
              <span>Total VAT:</span>
              <span>${invoice.total_vat.toFixed(2)} PLN</span>
            </div>
            <div class="total-row">
              <span>Total Gross:</span>
              <span>${invoice.total_gross.toFixed(2)} PLN</span>
            </div>
          </div>
        `;

        invoiceContainer.innerHTML = html;
      }

      // Function to download invoice PDF
      function downloadInvoicePdf(id) {
        // Show loading message
        showMessage('success', 'Generating PDF...');

        // Create a hidden iframe to handle the download
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        // Set the iframe source to the PDF endpoint
        iframe.src = `/api/invoices/${id}/pdf`;

        // Remove the iframe after a delay
        setTimeout(() => {
          document.body.removeChild(iframe);
        }, 2000);
      }

      // Function to show messages
      function showMessage(type, message) {
        messageContainer.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${message}</div>`;
        messageContainer.style.display = 'block';

        // Add some basic styling for messages
        const style = document.createElement('style');
        style.textContent = `
          .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
          .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
          }
          @media print {
            header, footer, .actions, #message-container {
              display: none !important;
            }
            .invoice-container {
              box-shadow: none;
              padding: 0;
            }
            body {
              font-size: 12pt;
            }
          }
        `;
        document.head.appendChild(style);

        // Auto-hide message after 5 seconds
        setTimeout(() => {
          messageContainer.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>
</html>
